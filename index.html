<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Banditi - Team Stats</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  body {
    background-color: #1f1f2e;
    color: #f0f0f0;
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
  }
  .nav {
    margin-bottom: 15px;
  }
  .nav button {
    background-color: #00ffc8;
    color: #1f1f2e;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    margin-right: 8px;
  }
  .nav button:hover {
    background-color: #00d1a8;
  }
  .section {
    display: none;
  }
  .section.active {
    display: block;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #2a2a3d;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    margin-bottom: 10px;
  }
  th, td {
    padding: 8px 12px;
    text-align: center;
    vertical-align: middle;
    border-bottom: 1px solid #3c3c50;
  }
  th {
    background-color: #34344a;
    color: #00ffc8;
    font-weight: bold;
  }
  tr:nth-child(even) {
    background-color: #262636;
  }
  tr:hover {
    background-color: #3a3a56;
  }
  .role-icon {
    font-size: 1.3em;
  }
  .info-icon {
    cursor: pointer;
    color: #00ffc8;
    font-weight: bold;
    font-size: 1.2em;
    user-select: none;
  }
  .role-select {
    background-color: #262636;
    border: none;
    color: #00ffc8;
    font-weight: bold;
    cursor: pointer;
    border-radius: 6px;
    padding: 2px 5px;
  }
  button.action-btn {
    background-color: #00ffc8;
    color: #1f1f2e;
    border: none;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 8px;
    margin-bottom: 20px;
  }
  button.action-btn:hover {
    background-color: #00d1a8;
  }
  /* Modal */
  #infoModal {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #2a2a3d;
    border: 2px solid #00ffc8;
    padding: 20px;
    border-radius: 10px;
    z-index: 1000;
    width: 320px;
  }
  #modalOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }
  #infoText {
    width: 100%;
    height: 120px;
    background: #1f1f2e;
    color: #00ffc8;
    border: none;
    resize: none;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
    padding: 6px;
    border-radius: 6px;
  }
  .tables-charts-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .table-wrapper, .chart-wrapper {
    flex: 1 1 400px;
    min-width: 300px;
  }
  canvas {
    width: 100% !important;
    height: 400px !important;
  }
  #guildInfoText {
    width: 100%;
    height: 400px;
    background: #1f1f2e;
    border: 2px solid #00ffc8;
    color: #00ffc8;
    padding: 10px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 16px;
    border-radius: 10px;
    resize: vertical;
    white-space: pre-wrap;
  }
  /* Colors for workshop status */
  .status-positive {
    color: #0f0; /* zelen√° */
    font-weight: bold;
  }
  .status-negative {
    color: #f44; /* ƒçerven√° */
    font-weight: bold;
  }
  .status-ok {
    color: #00ffc8;
  }
</style>
</head>
<body>

<h1>Banditi - Team Stats</h1>

<div class="nav">
  <button onclick="showSection('players')">üë• Players Info</button>
  <button onclick="showSection('xp')">üìà XP Tournament</button>
  <button onclick="showSection('herocon')">‚öîÔ∏è HeroCon Tournament</button>
  <button onclick="showSection('guildinfo')">üè∞ Guild Info</button>
  <button onclick="toggleEditMode()" id="editModeBtn">Povolit √∫pravy</button>
</div>

<!-- Players Info Section -->
<div id="players" class="section active">
  <table id="playersTable">
    <thead>
      <tr>
        <th>Role</th>
        <th>Ikona</th>
        <th>Nickname</th>
        <th>Level</th>
        <th>Workshop Level</th>
        <th>Workshop Status</th>
        <th>Missed Fights</th>
        <th>Smazat</th>
      </tr>
    </thead>
    <tbody id="playersBody"></tbody>
  </table>
  <button class="action-btn" onclick="exportPDF('players')">Exportovat Players Info do PDF</button>
</div>

<!-- XP Tournament Section -->
<div id="xp" class="section">
  <div class="tables-charts-container">
    <div class="table-wrapper">
      <table id="xpTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>XP Gained</th>
          </tr>
        </thead>
        <tbody id="xpBody"></tbody>
      </table>
      <button class="action-btn" onclick="addRow('xpBody')">‚ûï P≈ôidat hr√°ƒçe</button>
      <button class="action-btn" onclick="exportPDF('xp')">Exportovat XP Tournament do PDF</button>
    </div>
    <div class="chart-wrapper">
      <canvas id="xpChart"></canvas>
    </div>
  </div>
</div>

<!-- HeroCon Tournament Section -->
<div id="herocon" class="section">
  <div class="tables-charts-container">
    <div class="table-wrapper">
      <table id="heroconTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>HeroCon Gained</th>
          </tr>
        </thead>
        <tbody id="heroconBody"></tbody>
      </table>
      <button class="action-btn" onclick="addRow('heroconBody')">‚ûï P≈ôidat hr√°ƒçe</button>
      <button class="action-btn" onclick="exportPDF('herocon')">Exportovat HeroCon Tournament do PDF</button>
    </div>
    <div class="chart-wrapper">
      <canvas id="heroconChart"></canvas>
    </div>
  </div>
</div>

<!-- Guild Info Section -->
<div id="guildinfo" class="section">
  <textarea id="guildInfoText" placeholder="Zde napi≈° informace o guildƒõ..."></textarea><br/>
  <button class="action-btn" onclick="saveGuildInfo()">Ulo≈æit Guild Info</button>
</div>

<!-- Modal for player info -->
<div id="infoModal">
  <h3>Info o hr√°ƒçi</h3>
  <textarea id="infoText"></textarea><br/>
  <button onclick="saveInfo()">Ulo≈æit</button>
  <button onclick="closeModal()">Zru≈°it</button>
</div>
<div id="modalOverlay"></div>

<script>
  const { jsPDF } = window.jspdf;

  let editMode = false;

  // Data Players (load from localStorage or default)
  let playersData = JSON.parse(localStorage.getItem('playersData')) || [
    {name: 'Sazaro', level: 527, workshop: 20, missed: 0, info: 'Velitel t√Ωmu.', role: 'leader'},
    {name: 'Alfa', level: 521, workshop: 20, missed: 0, info: 'D≈Østojn√≠k.', role: 'officer'},
    {name: 'Liones', level: 515, workshop: 19, missed: 0, info: 'D≈Østojn√≠k.', role: 'officer'},
    {name: 'Bandita', level: 506, workshop: 20, missed: 0, info: 'D≈Østojn√≠k.', role: 'officer'},
    {name: 'Blesk', level: 500, workshop: 20, missed: 0, info: 'D≈Østojn√≠k.', role: 'officer'},
    {name: 'Ranny', level: 480, workshop: 19, missed: 0, info: 'D≈Østojn√≠k.', role: 'officer'},
    {name: 'Loniz1337', level: 475, workshop: 19, missed: 0, info: 'D≈Østojn√≠k.', role: 'officer'}
  ];

  // Load XP Tournament from localStorage or default
  let xpDataStorage = JSON.parse(localStorage.getItem('xpData')) || [
    {rank: 1, name: 'Alfa', gained: 1230},
    {rank: 2, name: 'Sazaro', gained: 980},
    {rank: 3, name: 'Bandita', gained: 840},
  ];

  // Load HeroCon Tournament from localStorage or default
  let heroconDataStorage = JSON.parse(localStorage.getItem('heroconData')) || [
    {rank: 1, name: 'Alfa', gained: 540},
    {rank: 2, name: 'Sazaro', gained: 480},
    {rank: 3, name: 'Bandita', gained: 300},
  ];

  // Load Guild Info from localStorage or empty
  let guildInfoText = localStorage.getItem('guildInfoText') || '';

  // Role icon function
  function roleIcon(role) {
    switch(role) {
      case 'leader': return 'üëë';
      case 'officer': return 'üõ°Ô∏è';
      default: return 'üë§';
    }
  }

  function calculateWorkshopStatus(level, workshop) {
    const limits = [
      {lvl: 500, w: 20}, {lvl: 450, w: 19}, {lvl: 400, w: 18}, {lvl: 350, w: 17},
      {lvl: 325, w: 16}, {lvl: 300, w: 15}, {lvl: 275, w: 14}, {lvl: 250, w: 13},
      {lvl: 230, w: 12}, {lvl: 210, w: 11}, {lvl: 190, w: 10}, {lvl: 170, w: 9},
      {lvl: 150, w: 8}, {lvl: 100, w: 7},
    ];
    let allowed = 7;
    for(let l of limits) {
      if(level >= l.lvl) {
        allowed = l.w;
        break;
      }
    }
    let diff = workshop - allowed;
    if(diff > 0) return '+' + diff;
    else if(diff < 0) return diff.toString();
    else return 'OK';
  }

  function renderPlayers() {
    const tbody = document.getElementById('playersBody');
    tbody.innerHTML = '';
    playersData.forEach((p, idx) => {
      const tr = document.createElement('tr');

      // Role cell
      const tdRole = document.createElement('td');
      if(editMode) {
        const select = document.createElement('select');
        select.className = 'role-select';
        ['leader', 'officer', 'member'].forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.text = r.charAt(0).toUpperCase() + r.slice(1);
          if(r === p.role) opt.selected = true;
          select.appendChild(opt);
        });
        select.onchange = e => {
          p.role = e.target.value;
          savePlayersData();
          renderPlayers();
        };
        tdRole.appendChild(select);
      } else {
        tdRole.textContent = p.role.charAt(0).toUpperCase() + p.role.slice(1);
      }
      tr.appendChild(tdRole);

      // Role icon
      const tdIcon = document.createElement('td');
      tdIcon.className = 'role-icon';
      tdIcon.textContent = roleIcon(p.role);
      tr.appendChild(tdIcon);

      // Nickname + info icon
      const tdName = document.createElement('td');
      tdName.textContent = p.name + ' ';
      const infoBtn = document.createElement('span');
      infoBtn.className = 'info-icon';
      infoBtn.textContent = '‚ÑπÔ∏è';
      infoBtn.title = "Upravit info hr√°ƒçe";
      infoBtn.onclick = () => openInfoModal(idx);
      tdName.appendChild(infoBtn);
      tr.appendChild(tdName);

      // Level
      const tdLevel = document.createElement('td');
      tdLevel.contentEditable = editMode;
      tdLevel.textContent = p.level;
      tdLevel.oninput = () => {
        const val = parseInt(tdLevel.textContent) || 0;
        p.level = val;
        savePlayersData();
        renderPlayers();
      };
      tr.appendChild(tdLevel);

      // Workshop Level
      const tdWorkshop = document.createElement('td');
      tdWorkshop.contentEditable = editMode;
      tdWorkshop.textContent = p.workshop;
      tdWorkshop.oninput = () => {
        const val = parseInt(tdWorkshop.textContent) || 0;
        p.workshop = val;
        savePlayersData();
        renderPlayers();
      };
      tr.appendChild(tdWorkshop);

      // Workshop Status with colors
      const tdStatus = document.createElement('td');
      let statusVal = calculateWorkshopStatus(p.level, p.workshop);
      tdStatus.textContent = statusVal;
      if(statusVal === 'OK') {
        tdStatus.className = 'status-ok';
      } else if(statusVal.startsWith('+')) {
        tdStatus.className = 'status-positive';
      } else if(statusVal.startsWith('-')) {
        tdStatus.className = 'status-negative';
      }
      tr.appendChild(tdStatus);

      // Missed fights
      const tdMissed = document.createElement('td');
      tdMissed.contentEditable = editMode;
      tdMissed.textContent = p.missed;
      tdMissed.oninput = () => {
        const val = parseInt(tdMissed.textContent) || 0;
        p.missed = val;
        savePlayersData();
      };
      tr.appendChild(tdMissed);

      // Info (schov√°no v tabulce - neukazuje se)
      // tr.appendChild(document.createElement('td')); // sloupec info jsme odstranili

      // Delete button
      const tdDel = document.createElement('td');
      if(editMode) {
        const btn = document.createElement('button');
        btn.textContent = 'Smazat';
        btn.onclick = () => {
          if(confirm(`Opravdu smazat hr√°ƒçe ${p.name}?`)) {
            playersData.splice(idx, 1);
            savePlayersData();
            renderPlayers();
          }
        };
        tdDel.appendChild(btn);
      }
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    });
  }

  // Save playersData to localStorage
  function savePlayersData() {
    localStorage.setItem('playersData', JSON.stringify(playersData));
  }

  // Modal for player info editing
  let currentEditIndex = null;
  function openInfoModal(index) {
    currentEditIndex = index;
    const modal = document.getElementById('infoModal');
    const overlay = document.getElementById('modalOverlay');
    const textarea = document.getElementById('infoText');
    textarea.value = playersData[index].info || '';
    modal.style.display = 'block';
    overlay.style.display = 'block';
  }
  function closeModal(save = true) {
    const modal = document.getElementById('infoModal');
    const overlay = document.getElementById('modalOverlay');
    if(save && currentEditIndex !== null) {
      const val = document.getElementById('infoText').value.trim();
      playersData[currentEditIndex].info = val;
      savePlayersData();
      renderPlayers();
    }
    modal.style.display = 'none';
    overlay.style.display = 'none';
    currentEditIndex = null;
  }
  function saveInfo() {
    closeModal(true);
  }

  // XP and HeroCon tournament render and edit

  function renderTournamentTable(tbodyId, dataArray) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '';
    dataArray.forEach((d, i) => {
      const tr = document.createElement('tr');

      // Rank
      const tdRank = document.createElement('td');
      tdRank.textContent = d.rank;
      tdRank.contentEditable = editMode;
      tdRank.oninput = () => {
        const val = parseInt(tdRank.textContent) || 1;
        d.rank = val;
        saveTournamentData(tbodyId, dataArray);
        updateCharts();
      };
      tr.appendChild(tdRank);

      // Name
      const tdName = document.createElement('td');
      tdName.textContent = d.name;
      tdName.contentEditable = editMode;
      tdName.oninput = () => {
        d.name = tdName.textContent;
        saveTournamentData(tbodyId, dataArray);
        updateCharts();
      };
      tr.appendChild(tdName);

      // Gained
      const tdGained = document.createElement('td');
      tdGained.textContent = d.gained;
      tdGained.contentEditable = editMode;
      tdGained.oninput = () => {
        d.gained = parseInt(tdGained.textContent) || 0;
        saveTournamentData(tbodyId, dataArray);
        updateCharts();
      };
      tr.appendChild(tdGained);

      tbody.appendChild(tr);
    });
  }

  // Save tournament data to localStorage
  function saveTournamentData(tbodyId, dataArray) {
    if(tbodyId === 'xpBody') {
      localStorage.setItem('xpData', JSON.stringify(dataArray));
    } else if(tbodyId === 'heroconBody') {
      localStorage.setItem('heroconData', JSON.stringify(dataArray));
    }
  }

  // Add new row to tournament table
  function addRow(tbodyId) {
    let dataArray = tbodyId === 'xpBody' ? xpDataStorage : heroconDataStorage;
    let newRank = dataArray.length + 1;
    dataArray.push({rank: newRank, name: 'Nov√Ω hr√°ƒç', gained: 0});
    saveTournamentData(tbodyId, dataArray);
    renderTournamentTable(tbodyId, dataArray);
    updateCharts();
  }

  // Chart data update
  function getTableData(tbodyId) {
    const tbody = document.getElementById(tbodyId);
    let labels = [];
    let data = [];
    for(let row of tbody.rows) {
      let name = row.cells[1].textContent.trim();
      let gained = parseInt(row.cells[2].textContent) || 0;
      labels.push(name);
      data.push(gained);
    }
    return {labels, data};
  }

  // Create Charts
  const xpCtx = document.getElementById('xpChart').getContext('2d');
  const heroconCtx = document.getElementById('heroconChart').getContext('2d');

  const xpChart = new Chart(xpCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'XP Gained',
        data: [],
        backgroundColor: '#00ffc8',
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  const heroconChart = new Chart(heroconCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'HeroCon Gained',
        data: [],
        backgroundColor: '#00ffc8',
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Update charts from table data
  function updateCharts() {
    let xpData = getTableData('xpBody');
    xpChart.data.labels = xpData.labels;
    xpChart.data.datasets[0].data = xpData.data;
    xpChart.update();

    let heroconData = getTableData('heroconBody');
    heroconChart.data.labels = heroconData.labels;
    heroconChart.data.datasets[0].data = heroconData.data;
    heroconChart.update();
  }

  // Guild info save/load
  function saveGuildInfo() {
    const text = document.getElementById('guildInfoText').value;
    localStorage.setItem('guildInfoText', text);
    alert('Guild info ulo≈æeno.');
  }
  function loadGuildInfo() {
    document.getElementById('guildInfoText').value = guildInfoText;
  }

  // Edit mode toggle
  function toggleEditMode() {
    editMode = !editMode;
    document.getElementById('editModeBtn').textContent = editMode ? 'Zak√°zat √∫pravy' : 'Povolit √∫pravy';
    renderPlayers();
    renderTournamentTable('xpBody', xpDataStorage);
    renderTournamentTable('heroconBody', heroconDataStorage);
  }

  // Show section
  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // Export tables to PDF
  function exportPDF(section) {
    let doc = new jsPDF();
    let title = '';
    let headers = [];
    let rows = [];
    let date = new Date().toLocaleString();

    if(section === 'players') {
      title = 'Players Info - Banditi';
      headers = ['Role', 'Ikona', 'Nickname', 'Level', 'Workshop Level', 'Workshop Status', 'Missed Fights', 'Info'];
      rows = playersData.map(p => [
        p.role.charAt(0).toUpperCase() + p.role.slice(1),
        roleIcon(p.role),
        p.name,
        p.level,
        p.workshop,
        calculateWorkshopStatus(p.level, p.workshop),
        p.missed,
        p.info || ''
      ]);
    } else if(section === 'xp') {
      title = 'XP Tournament - Banditi';
      headers = ['Rank', 'Name', 'XP Gained'];
      rows = xpDataStorage.map(d => [d.rank, d.name, d.gained]);
    } else if(section === 'herocon') {
      title = 'HeroCon Tournament - Banditi';
      headers = ['Rank', 'Name', 'HeroCon Gained'];
      rows = heroconDataStorage.map(d => [d.rank, d.name, d.gained]);
    } else {
      alert('Nepodporovan√° sekce pro export PDF');
      return;
    }

    doc.setTextColor('#00ffc8');
    doc.setFontSize(16);
    doc.text(title, 14, 20);
    doc.setFontSize(10);
    doc.setTextColor('#fff');
    doc.text(`Exportov√°no: ${date}`, 14, 28);

    doc.autoTable({
      head: [headers],
      body: rows,
      startY: 35,
      theme: 'grid',
      headStyles: {fillColor: [0, 255, 200]},
      styles: {textColor: [255, 255, 255], fillColor: [35, 35, 45]}
    });

    doc.save(`${title.replace(/\s/g, '_')}_${date.replace(/[: ,]/g,'-')}.pdf`);
  }

  // Initial rendering
  function init() {
    renderPlayers();
    renderTournamentTable('xpBody', xpDataStorage);
    renderTournamentTable('heroconBody', heroconDataStorage);
    toggleEditMode(); // start with edit disabled
    toggleEditMode(); // re-render in default mode (off)
    updateCharts();
    loadGuildInfo();
  }

  // Modal overlay click closes modal
  document.getElementById('modalOverlay').addEventListener('click', () => closeModal(false));

  init();

</script>
</body>
</html>
