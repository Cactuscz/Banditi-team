<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Banditi - Team Stats</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAMuBW2ZZVja7lcf88cJuBmCXJzjp35Ur0",
    authDomain: "banditi-c15a8.firebaseapp.com",
    projectId: "banditi-c15a8",
    storageBucket: "banditi-c15a8.firebasestorage.app",
    messagingSenderId: "185952741494",
    appId: "1:185952741494:web:3069a101b847b661e91757",
    measurementId: "G-NK07GNCLJ4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Exportujeme do window, aby k√≥d mimo module mohl p≈ôistupovat
  window.db = db;
  window.firebaseLoadData = async function() {
    const docRef = doc(db, "banditi", "data");
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()) {
      const data = docSnap.data();
      window.playersData = data.playersData || [];
      window.xpDataStorage = data.xpData || [];
      window.heroconDataStorage = data.heroconData || [];
      window.guildInfoText = data.guildInfoText || '';
    } else {
      window.playersData = [];
      window.xpDataStorage = [];
      window.heroconDataStorage = [];
      window.guildInfoText = '';
    }
  };

  window.firebaseSaveAll = async function() {
    const docRef = doc(db, "banditi", "data");
    await setDoc(docRef, {
      playersData: window.playersData,
      xpData: window.xpDataStorage,
      heroconData: window.heroconDataStorage,
      guildInfoText: window.guildInfoText
    });
  };
</script>

<style>
/* -- tady nech√°v√°m tv≈Øj styl stejn√Ω -- */
body {
  background-color: #1f1f2e;
  color: #f0f0f0;
  font-family: 'Segoe UI', sans-serif;
  padding: 20px;
}
.nav {
  margin-bottom: 15px;
}
.nav button {
  background-color: #00ffc8;
  color: #1f1f2e;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  margin-right: 8px;
}
.nav button:hover {
  background-color: #00d1a8;
}
.section {
  display: none;
}
.section.active {
  display: block;
}
table {
  width: 100%;
  border-collapse: collapse;
  background-color: #2a2a3d;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 0 15px rgba(0,0,0,0.5);
  margin-bottom: 10px;
}
th, td {
  padding: 8px 12px;
  text-align: center;
  vertical-align: middle;
  border-bottom: 1px solid #3c3c50;
}
th {
  background-color: #34344a;
  color: #00ffc8;
  font-weight: bold;
}
tr:nth-child(even) {
  background-color: #262636;
}
tr:hover {
  background-color: #3a3a56;
}
.role-icon {
  font-size: 1.3em;
}
.info-icon {
  cursor: pointer;
  color: #00ffc8;
  font-weight: bold;
  font-size: 1.2em;
  user-select: none;
}
.role-select {
  background-color: #262636;
  border: none;
  color: #00ffc8;
  font-weight: bold;
  cursor: pointer;
  border-radius: 6px;
  padding: 2px 5px;
}
button.action-btn {
  background-color: #00ffc8;
  color: #1f1f2e;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  margin-top: 8px;
  margin-bottom: 20px;
}
button.action-btn:hover {
  background-color: #00d1a8;
}
/* Modal */
#infoModal {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: #2a2a3d;
  border: 2px solid #00ffc8;
  padding: 20px;
  border-radius: 10px;
  z-index: 1000;
  width: 320px;
}
#modalOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}
#infoText {
  width: 100%;
  height: 120px;
  background: #1f1f2e;
  color: #00ffc8;
  border: none;
  resize: none;
  font-family: 'Segoe UI', sans-serif;
  font-size: 14px;
  padding: 6px;
  border-radius: 6px;
}
.tables-charts-container {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}
.table-wrapper, .chart-wrapper {
  flex: 1 1 400px;
  min-width: 300px;
}
canvas {
  width: 100% !important;
  height: 400px !important;
}
#guildInfoText {
  width: 100%;
  height: 400px;
  background: #1f1f2e;
  border: 2px solid #00ffc8;
  color: #00ffc8;
  padding: 10px;
  font-family: 'Segoe UI', sans-serif;
  font-size: 16px;
  border-radius: 10px;
  resize: vertical;
  white-space: pre-wrap;
}
/* Colors for workshop status */
.status-positive {
  color: #0f0;
  font-weight: bold;
}
.status-negative {
  color: #f44;
  font-weight: bold;
}
.status-ok {
  color: #00ffc8;
}
</style>
</head>
<body>

<h1>Banditi - Team Stats</h1>

<div class="nav">
  <button onclick="showSection('players')">üë• Players Info</button>
  <button onclick="showSection('xp')">üìà XP Tournament</button>
  <button onclick="showSection('herocon')">‚öîÔ∏è HeroCon Tournament</button>
  <button onclick="showSection('guildinfo')">üè∞ Guild Info</button>
  <button onclick="toggleEditMode()" id="editModeBtn">Povolit √∫pravy</button>
</div>

<!-- Players Info Section -->
<div id="players" class="section active">
  <table id="playersTable">
    <thead>
      <tr>
        <th>Role</th>
        <th>Ikona</th>
        <th>Nickname</th>
        <th>Level</th>
        <th>Workshop Level</th>
        <th>Workshop Status</th>
        <th>Missed Fights</th>
        <th>Smazat</th>
      </tr>
    </thead>
    <tbody id="playersBody"></tbody>
  </table>
  <button class="action-btn" onclick="addPlayer()">‚ûï P≈ôidat hr√°ƒçe</button>
  <button class="action-btn" onclick="exportPDF('players')">Exportovat Players Info do PDF</button>
  <h3>Limity d√≠len</h3>
<table>
  <thead>
    <tr>
      <th>Limit d√≠len</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>100</td><td>7</td></tr>
    <tr><td>150</td><td>8</td></tr>
    <tr><td>170</td><td>9</td></tr>
    <tr><td>190</td><td>10</td></tr>
    <tr><td>210</td><td>11</td></tr>
    <tr><td>230</td><td>12</td></tr>
    <tr><td>250</td><td>13</td></tr>
    <tr><td>275</td><td>14</td></tr>
    <tr><td>300</td><td>15</td></tr>
    <tr><td>325</td><td>16</td></tr>
    <tr><td>350</td><td>17</td></tr>
    <tr><td>400</td><td>18</td></tr>
    <tr><td>450</td><td>19</td></tr>
    <tr><td>500</td><td>20</td></tr>
    <tr><td>550</td><td>21</td></tr>
  </tbody>
</table>
</div>

<!-- XP Tournament Section -->
<div id="xp" class="section">
  <div class="tables-charts-container">
    <div class="table-wrapper">
      <table id="xpTable">
        <thead>
          <tr>
            <th>Jm√©no</th>
            <th>XP</th>
          </tr>
        </thead>
        <tbody id="xpBody"></tbody>
      </table>
      <button class="action-btn" onclick="addXP()">‚ûï P≈ôidat XP</button>
      <button class="action-btn" onclick="exportPDF('xp')">Exportovat XP Tournament do PDF</button>
    </div>
    <div class="chart-wrapper">
      <canvas id="xpChart"></canvas>
    </div>
  </div>
</div>

<!-- HeroCon Tournament Section -->
<div id="herocon" class="section">
  <div class="tables-charts-container">
    <div class="table-wrapper">
      <table id="heroconTable">
        <thead>
          <tr>
            <th>Jm√©no</th>
            <th>HeroCon Score</th>
          </tr>
        </thead>
        <tbody id="heroconBody"></tbody>
      </table>
      <button class="action-btn" onclick="addHeroCon()">‚ûï P≈ôidat HeroCon</button>
      <button class="action-btn" onclick="exportPDF('herocon')">Exportovat HeroCon Tournament do PDF</button>
    </div>
    <div class="chart-wrapper">
      <canvas id="heroconChart"></canvas>
    </div>
  </div>
</div>

<!-- Guild Info Section -->
<div id="guildinfo" class="section">
  <textarea id="guildInfoText" placeholder="Zde napi≈° informace o guildƒõ..."></textarea>
  <button class="action-btn" onclick="saveGuildInfo()">Ulo≈æit Guild Info</button>
</div>

<!-- Modal for workshop info -->
<div id="modalOverlay"></div>
<div id="infoModal">
  <textarea id="infoText" readonly></textarea>
  <button class="action-btn" onclick="closeModal()">Zav≈ô√≠t</button>
</div>

<script>
let editMode = false;

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById('editModeBtn').addEventListener('click', toggleEditMode);

function toggleEditMode() {
  editMode = !editMode;
  document.getElementById('editModeBtn').textContent = editMode ? 'Zak√°zat √∫pravy' : 'Povolit √∫pravy';
  renderPlayers();
  renderXP();
  renderHeroCon();
}

function openModal(text) {
  document.getElementById('infoText').value = text;
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById('infoModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  document.getElementById('infoModal').style.display = 'none';
}

// --- Data storage ---

// Inicializovan√© promƒõnn√© pro data
window.playersData = [];
window.xpDataStorage = [];
window.heroconDataStorage = [];
window.guildInfoText = "";

// Funkce pro v√Ωpoƒçet statusu d√≠lny
function workshopStatus(level, workshopLevel) {
  const limits = [
    { levelFrom: 100, maxWorkshop: 7 },
    { levelFrom: 150, maxWorkshop: 8 },
    { levelFrom: 170, maxWorkshop: 9 },
    { levelFrom: 190, maxWorkshop: 10 },
    { levelFrom: 210, maxWorkshop: 11 },
    { levelFrom: 230, maxWorkshop: 12 },
    { levelFrom: 250, maxWorkshop: 13 },
    { levelFrom: 275, maxWorkshop: 14 },
    { levelFrom: 300, maxWorkshop: 15 },
    { levelFrom: 325, maxWorkshop: 16 },
    { levelFrom: 350, maxWorkshop: 17 },
    { levelFrom: 400, maxWorkshop: 18 },
    { levelFrom: 450, maxWorkshop: 19 },
    { levelFrom: 500, maxWorkshop: 20 },
    { levelFrom: 550, maxWorkshop: 21 },
  ];
  let maxWorkshop = 0;
  for (const limit of limits) {
    if (level >= limit.levelFrom) maxWorkshop = limit.maxWorkshop;
  }
  if (workshopLevel > maxWorkshop) return {text: 'P≈ôekroƒçeno', className: 'status-negative'};
  if (workshopLevel === maxWorkshop) return {text: 'OK', className: 'status-ok'};
  return {text: 'OK', className: 'status-positive'};
}

// --- Players ---

function renderPlayers() {
  const tbody = document.getElementById('playersBody');
  tbody.innerHTML = '';
  for (const player of window.playersData) {
    const tr = document.createElement('tr');

    // Role icon
    const roleCell = document.createElement('td');
    roleCell.textContent = player.role || '';
    tr.appendChild(roleCell);

    // Role icon (like commander/officer)
    const iconCell = document.createElement('td');
    let icon = '';
    if(player.role === 'Velitel') icon = 'üëë';
    else if(player.role === 'D≈Østojn√≠k') icon = '‚öîÔ∏è';
    iconCell.textContent = icon;
    iconCell.className = 'role-icon';
    tr.appendChild(iconCell);

    // Nickname
    const nickCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.value = player.name || '';
      input.onchange = e => {
        player.name = e.target.value;
        saveData();
        renderPlayers();
      };
      nickCell.appendChild(input);
    } else {
      nickCell.textContent = player.name;
    }
    tr.appendChild(nickCell);

    // Level
    const levelCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = player.level || 0;
      input.onchange = e => {
        player.level = parseInt(e.target.value) || 0;
        saveData();
        renderPlayers();
      };
      levelCell.appendChild(input);
    } else {
      levelCell.textContent = player.level;
    }
    tr.appendChild(levelCell);

    // Workshop Level
    const workshopCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = player.workshop || 0;
      input.onchange = e => {
        player.workshop = parseInt(e.target.value) || 0;
        saveData();
        renderPlayers();
      };
      workshopCell.appendChild(input);
    } else {
      workshopCell.textContent = player.workshop;
    }
    tr.appendChild(workshopCell);

    // Workshop Status
    const status = workshopStatus(player.level, player.workshop);
    const statusCell = document.createElement('td');
    statusCell.textContent = status.text;
    statusCell.className = status.className;
    tr.appendChild(statusCell);

    // Missed Fights
    const missedCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = player.missedFights || 0;
      input.onchange = e => {
        player.missedFights = parseInt(e.target.value) || 0;
        saveData();
        renderPlayers();
      };
      missedCell.appendChild(input);
    } else {
      missedCell.textContent = player.missedFights || 0;
    }
    tr.appendChild(missedCell);

    // Delete button
    const delCell = document.createElement('td');
    if(editMode) {
      const btn = document.createElement('button');
      btn.textContent = '‚ùå';
      btn.onclick = () => {
        if(confirm(`Smazat hr√°ƒçe ${player.name}?`)) {
          window.playersData = window.playersData.filter(p => p !== player);
          saveData();
          renderPlayers();
        }
      };
      delCell.appendChild(btn);
    }
    tr.appendChild(delCell);

    tbody.appendChild(tr);
  }
}

// --- XP Tournament ---

function renderXP() {
  const tbody = document.getElementById('xpBody');
  tbody.innerHTML = '';
  for (const entry of window.xpDataStorage) {
    const tr = document.createElement('tr');
    const nameCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.value = entry.name || '';
      input.onchange = e => {
        entry.name = e.target.value;
        saveData();
        renderXP();
      };
      nameCell.appendChild(input);
    } else {
      nameCell.textContent = entry.name;
    }
    tr.appendChild(nameCell);

    const xpCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = entry.xp || 0;
      input.onchange = e => {
        entry.xp = parseInt(e.target.value) || 0;
        saveData();
        renderXP();
      };
      xpCell.appendChild(input);
    } else {
      xpCell.textContent = entry.xp;
    }
    tr.appendChild(xpCell);

    tbody.appendChild(tr);
  }
  updateXPChart();
}

// --- HeroCon Tournament ---

function renderHeroCon() {
  const tbody = document.getElementById('heroconBody');
  tbody.innerHTML = '';
  for (const entry of window.heroconDataStorage) {
    const tr = document.createElement('tr');
    const nameCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.value = entry.name || '';
      input.onchange = e => {
        entry.name = e.target.value;
        saveData();
        renderHeroCon();
      };
      nameCell.appendChild(input);
    } else {
      nameCell.textContent = entry.name;
    }
    tr.appendChild(nameCell);

    const scoreCell = document.createElement('td');
    if(editMode) {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = entry.score || 0;
      input.onchange = e => {
        entry.score = parseInt(e.target.value) || 0;
        saveData();
        renderHeroCon();
      };
      scoreCell.appendChild(input);
    } else {
      scoreCell.textContent = entry.score;
    }
    tr.appendChild(scoreCell);

    tbody.appendChild(tr);
  }
  updateHeroConChart();
}

// --- Guild Info ---

function renderGuildInfo() {
  document.getElementById('guildInfoText').value = window.guildInfoText || '';
}

function saveGuildInfo() {
  window.guildInfoText = document.getElementById('guildInfoText').value;
  saveData();
  alert('Guild info ulo≈æeno!');
}

// --- Adding entries ---

function addPlayer() {
  window.playersData.push({
    role: '',
    name: '',
    level: 0,
    workshop: 0,
    missedFights: 0,
  });
  saveData();
  renderPlayers();
}

function addXP() {
  window.xpDataStorage.push({name:'', xp: 0});
  saveData();
  renderXP();
}

function addHeroCon() {
  window.heroconDataStorage.push({name:'', score:0});
  saveData();
  renderHeroCon();
}

// --- Save data to Firebase ---

async function saveData() {
  await window.firebaseSaveAll();
}

// --- PDF export ---

async function exportPDF(section) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  if(section === 'players') {
    doc.text("Players Info", 10, 10);
    doc.autoTable({
      startY: 15,
      head: [['Role', 'Nickname', 'Level', 'Workshop', 'Missed Fights']],
      body: window.playersData.map(p => [p.role, p.name, p.level, p.workshop, p.missedFights])
    });
  } else if(section === 'xp') {
    doc.text("XP Tournament", 10, 10);
    doc.autoTable({
      startY: 15,
      head: [['Jm√©no', 'XP']],
      body: window.xpDataStorage.map(x => [x.name, x.xp])
    });
  } else if(section === 'herocon') {
    doc.text("HeroCon Tournament", 10, 10);
    doc.autoTable({
      startY: 15,
      head: [['Jm√©no', 'HeroCon Score']],
      body: window.heroconDataStorage.map(h => [h.name, h.score])
    });
  }

  doc.save(`${section}.pdf`);
}

// --- Charts ---

let xpChart, heroconChart;

function updateXPChart() {
  const ctx = document.getElementById('xpChart').getContext('2d');
  if(xpChart) xpChart.destroy();

  xpChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: window.xpDataStorage.map(e => e.name),
      datasets: [{
        label: 'XP',
        data: window.xpDataStorage.map(e => e.xp),
        backgroundColor: '#00ffc8'
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function updateHeroConChart() {
  const ctx = document.getElementById('heroconChart').getContext('2d');
  if(heroconChart) heroconChart.destroy();

  heroconChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: window.heroconDataStorage.map(e => e.name),
      datasets: [{
        label: 'HeroCon Score',
        data: window.heroconDataStorage.map(e => e.score),
        backgroundColor: '#00ffc8'
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// --- Inicializace dat a vykreslen√≠ ---

async function init() {
  await window.firebaseLoadData();
  renderPlayers();
  renderXP();
  renderHeroCon();
  renderGuildInfo();
}

window.onload = init;
</script>

</body>
</html>
