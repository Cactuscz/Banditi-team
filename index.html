<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Banditi - Team Stats</title>

<!-- Knihovny -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase SDK (compat verze) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  body {
    background-color: #1f1f2e;
    color: #f0f0f0;
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
  }
  /* ... tady m≈Ø≈æe≈° m√≠t stejn√Ω CSS jako m√°≈° v√Ω≈°e ... */
  .nav {
    margin-bottom: 15px;
  }
  .nav button {
    background-color: #00ffc8;
    color: #1f1f2e;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    margin-right: 8px;
  }
  .nav button:hover {
    background-color: #00d1a8;
  }
  .section {
    display: none;
  }
  .section.active {
    display: block;
  }
  /* Dal≈°√≠ stylov√°n√≠... */
</style>
</head>
<body>

<h1>Banditi - Team Stats</h1>

<div class="nav">
  <button onclick="showSection('players')">üë• Players Info</button>
  <button onclick="showSection('xp')">üìà XP Tournament</button>
  <button onclick="showSection('herocon')">‚öîÔ∏è HeroCon Tournament</button>
  <button onclick="showSection('guildinfo')">üè∞ Guild Info</button>
  <button onclick="toggleEditMode()" id="editModeBtn">Povolit √∫pravy</button>
</div>

<!-- Players Info Section -->
<div id="players" class="section active">
  <table id="playersTable">
    <thead>
      <tr>
        <th>Role</th>
        <th>Ikona</th>
        <th>Nickname</th>
        <th>Level</th>
        <th>Workshop Level</th>
        <th>Workshop Status</th>
        <th>Missed Fights</th>
        <th>Smazat</th>
      </tr>
    </thead>
    <tbody id="playersBody"></tbody>
  </table>
  <button class="action-btn" onclick="addPlayer()">‚ûï P≈ôidat hr√°ƒçe</button>
  <button class="action-btn" onclick="exportPDF('players')">Exportovat Players Info do PDF</button>

  <!-- Limity d√≠len -->
  <h3>Limity d√≠len</h3>
  <table>
    <thead>
      <tr>
        <th>Level od</th>
        <th>Maxim√°ln√≠ d√≠lna</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>100</td><td>7</td></tr>
      <tr><td>150</td><td>8</td></tr>
      <tr><td>170</td><td>9</td></tr>
      <tr><td>190</td><td>10</td></tr>
      <tr><td>210</td><td>11</td></tr>
      <tr><td>230</td><td>12</td></tr>
      <tr><td>250</td><td>13</td></tr>
      <tr><td>275</td><td>14</td></tr>
      <tr><td>300</td><td>15</td></tr>
      <tr><td>325</td><td>16</td></tr>
      <tr><td>350</td><td>17</td></tr>
      <tr><td>400</td><td>18</td></tr>
      <tr><td>450</td><td>19</td></tr>
      <tr><td>500</td><td>20</td></tr>
    </tbody>
  </table>
</div>

<!-- XP Tournament Section -->
<div id="xp" class="section">
  <p>Zde je sekce XP Tournament (zat√≠m bez Firebase, m≈Ø≈æe≈° p≈ôidat pozdƒõji)</p>
</div>

<!-- HeroCon Tournament Section -->
<div id="herocon" class="section">
  <p>Zde je sekce HeroCon Tournament (zat√≠m bez Firebase, m≈Ø≈æe≈° p≈ôidat pozdƒõji)</p>
</div>

<!-- Guild Info Section -->
<div id="guildinfo" class="section">
  <textarea id="guildInfoText" placeholder="Zde napi≈° informace o guildƒõ..."></textarea><br/>
  <button class="action-btn" onclick="saveGuildInfo()">Ulo≈æit Guild Info</button>
</div>

<!-- Modal for player info -->
<div id="infoModal" style="display:none; position:fixed; top:50%; left:50%; transform: translate(-50%, -50%); background:#2a2a3d; border: 2px solid #00ffc8; padding:20px; border-radius:10px; z-index:1000; width:320px;">
  <h3>Info o hr√°ƒçi</h3>
  <textarea id="infoText" style="width:100%; height:120px; background:#1f1f2e; color:#00ffc8; border:none; resize:none; font-family:'Segoe UI', sans-serif; font-size:14px; padding:6px; border-radius:6px;"></textarea><br/>
  <button onclick="saveInfo()">Ulo≈æit</button>
  <button onclick="closeModal()">Zru≈°it</button>
</div>
<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>

<script>
  const { jsPDF } = window.jspdf;

  // --- Firebase konfigurace a inicializace ---
  const firebaseConfig = {
    apiKey: "AIzaSyAMuBW2ZZVja7lcf88cJuBmCXJzjp35Ur0",
    authDomain: "banditi-c15a8.firebaseapp.com",
    projectId: "banditi-c15a8",
    storageBucket: "banditi-c15a8.firebasestorage.app",
    messagingSenderId: "185952741494",
    appId: "1:185952741494:web:3069a101b847b661e91757",
    measurementId: "G-NK07GNCLJ4"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- Data ---
  let playersData = [];

  // Naƒçti hr√°ƒçe z Firestore
  function loadPlayersData() {
    return db.collection('players').get()
      .then(snapshot => {
        playersData = [];
        snapshot.forEach(doc => {
          playersData.push(doc.data());
        });
        renderPlayers();
      })
      .catch(err => console.error('Chyba p≈ôi naƒç√≠t√°n√≠ z Firestore:', err));
  }

  // Ulo≈æ hr√°ƒçe do Firestore
  function savePlayersData() {
    const batch = db.batch();
    const playersCollection = db.collection('players');
    playersData.forEach(player => {
      // Pou≈æ√≠v√°me nickname jako ID dokumentu (m≈Ø≈æe≈° zmƒõnit, pokud chce≈°)
      const docRef = playersCollection.doc(player.name);
      batch.set(docRef, player);
    });
    return batch.commit()
      .then(() => {
        console.log('Data hr√°ƒç≈Ø ulo≈æena do Firestore');
        renderPlayers();
      })
      .catch(err => console.error('Chyba p≈ôi ukl√°d√°n√≠ do Firestore:', err));
  }

  // --- Zbytek tv√©ho k√≥du pro renderov√°n√≠ tabulky, mod√°ln√≠ okno atd. ---
  // Funkce roleIcon atd. nech√°v√°m beze zmƒõny
  function roleIcon(role) {
    switch(role) {
      case 'leader': return 'üëë';
      case 'officer': return 'üõ°Ô∏è';
      default: return 'üë§';
    }
  }

  function calculateWorkshopStatus(level, workshop) {
    const limits = [
      {lvl: 500, w: 20}, {lvl: 450, w: 19}, {lvl: 400, w: 18}, {lvl: 350, w: 17},
      {lvl: 325, w: 16}, {lvl: 300, w: 15}, {lvl: 275, w: 14}, {lvl: 250, w: 13},
      {lvl: 230, w: 12}, {lvl: 210, w: 11}, {lvl: 190, w: 10}, {lvl: 170, w: 9},
      {lvl: 150, w: 8}, {lvl: 100, w: 7},
    ];
    let allowed = 7;
    for(let l of limits) {
      if(level >= l.lvl) {
        allowed = l.w;
        break;
      }
    }
    let diff = workshop - allowed;
    if(diff > 0) return '+' + diff;
    else if(diff < 0) return diff.toString();
    else return 'OK';
  }

  function updateWorkshopStatusStyle(td) {
    td.classList.remove('status-positive', 'status-negative', 'status-ok');
    const val = td.textContent.trim();
    if (val.includes('+')) {
      td.classList.add('status-positive');
    } else if (val.includes('-')) {
      td.classList.add('status-negative');
    } else {
      td.classList.add('status-ok');
    }
  }

  function renderPlayers() {
    const tbody = document.getElementById('playersBody');
    tbody.innerHTML = '';

    // Se≈ôad√≠me podle role a levelu
    const leaders = playersData.filter(p => p.role === 'leader');
    const officers = playersData.filter(p => p.role === 'officer').sort((a,b) => b.level - a.level);
    const members = playersData.filter(p => p.role === 'member').sort((a,b) => b.level - a.level);

    const sortedPlayers = [...leaders, ...officers, ...members];

    sortedPlayers.forEach((p, idx) => {
      const tr = document.createElement('tr');

      // Role select
      const tdRole = document.createElement('td');
      const select = document.createElement('select');
      select.className = 'role-select';
      ['leader', 'officer', 'member'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        if (p.role === role) option.selected = true;
        select.appendChild(option);
      });
      select.disabled = !editMode;
      select.onchange = () => {
        p.role = select.value;
        savePlayersData();
      };
      tdRole.appendChild(select);
      tr.appendChild(tdRole);

      // Ikona role
      const tdIcon = document.createElement('td');
      tdIcon.textContent = roleIcon(p.role);
      tr.appendChild(tdIcon);

      // Nickname + info button
      const tdName = document.createElement('td');
      const nameSpan = document.createElement('span');
      nameSpan.textContent = p.name;
      nameSpan.contentEditable = editMode;
      nameSpan.oninput = () => {
        p.name = nameSpan.textContent;
        savePlayersData();
      };
      tdName.appendChild(nameSpan);

      const infoBtn = document.createElement('span');
      infoBtn.className = 'info-icon';
      infoBtn.textContent = ' ‚ÑπÔ∏è';
      infoBtn.title = "Upravit info hr√°ƒçe";
      infoBtn.style.cursor = 'pointer';
      infoBtn.onclick = () => openInfoModal(playersData.indexOf(p));
      tdName.appendChild(infoBtn);
      tr.appendChild(tdName);

      // Level
      const tdLevel = document.createElement('td');
      tdLevel.contentEditable = editMode;
      tdLevel.textContent = p.level;
      tdLevel.oninput = () => {
        p.level = parseInt(tdLevel.textContent) || 0;
        savePlayersData();
      };
      tr.appendChild(tdLevel);

      // Workshop
      const tdWorkshop = document.createElement('td');
      tdWorkshop.contentEditable = editMode;
      tdWorkshop.textContent = p.workshop;
      tdWorkshop.oninput = () => {
        p.workshop = parseInt(tdWorkshop.textContent) || 0;
        tdWorkshop.textContent = p.workshop;
        updateWorkshopStatus();
        savePlayersData();
      };
      tr.appendChild(tdWorkshop);

      // Workshop status
      const tdWorkshopStatus = document.createElement('td');
      tdWorkshopStatus.textContent = calculateWorkshopStatus(p.level, p.workshop);
      updateWorkshopStatusStyle(tdWorkshopStatus);
      tr.appendChild(tdWorkshopStatus);

      // Missed fights
      const tdMissed = document.createElement('td');
      tdMissed.contentEditable = editMode;
      tdMissed.textContent = p.missedFights || 0;
      tdMissed.oninput = () => {
        p.missedFights = parseInt(tdMissed.textContent) || 0;
        savePlayersData();
      };
      tr.appendChild(tdMissed);

      // Smazat
      const tdDelete = document.createElement('td');
      if(editMode) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.title = 'Smazat hr√°ƒçe';
        delBtn.onclick = () => {
          if(confirm(`Opravdu chce≈° smazat hr√°ƒçe ${p.name}?`)) {
            playersData.splice(playersData.indexOf(p), 1);
            savePlayersData();
          }
        };
        tdDelete.appendChild(delBtn);
      }
      tr.appendChild(tdDelete);

      tbody.appendChild(tr);
    });

    updateWorkshopStatus();
  }

  // Aktualizuje v≈°echny statusy d√≠lny
  function updateWorkshopStatus() {
    const tbody = document.getElementById('playersBody');
    for(let tr of tbody.children) {
      const wsStatusTd = tr.children[6];
      const wsTd = tr.children[5];
      if(wsStatusTd && wsTd) {
        wsStatusTd.textContent = calculateWorkshopStatus(
          parseInt(tr.children[3].textContent) || 0,
          parseInt(tr.children[4].textContent) || 0
        );
        updateWorkshopStatusStyle(wsStatusTd);
      }
    }
  }

  // P≈ôidat hr√°ƒçe
  function addPlayer() {
    if(!editMode) {
      alert('Povol √∫pravy pro p≈ôid√°n√≠ hr√°ƒçe');
      return;
    }
    const newPlayer = {
      role: 'member',
      name: 'Nov√Ω hr√°ƒç',
      level: 0,
      workshop: 0,
      missedFights: 0,
      info: ''
    };
    playersData.push(newPlayer);
    savePlayersData();
  }

  // --- Edit info modal ---
  let editingPlayerIndex = null;

  function openInfoModal(index) {
    editingPlayerIndex = index;
    const player = playersData[index];
    document.getElementById('infoText').value = player.info || '';
    document.getElementById('infoModal').style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
  }
  function closeModal() {
    document.getElementById('infoModal').style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
  }
  function saveInfo() {
    if(editingPlayerIndex === null) return;
    playersData[editingPlayerIndex].info = document.getElementById('infoText').value;
    savePlayersData();
    closeModal();
  }

  // --- Sekce ---
  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // --- Edit mode ---
  let editMode = false;
  function toggleEditMode() {
    editMode = !editMode;
    document.getElementById('editModeBtn').textContent = editMode ? 'Zak√°zat √∫pravy' : 'Povolit √∫pravy';
    renderPlayers();
  }

  // --- Export do PDF ---
  function exportPDF(section) {
    const doc = new jsPDF();

    if(section === 'players') {
      const columns = ["Role", "Ikona", "Nickname", "Level", "Workshop", "Workshop Status", "Missed Fights", "Info"];
      const rows = playersData.map(p => [
        p.role,
        roleIcon(p.role),
        p.name,
        p.level,
        p.workshop,
        calculateWorkshopStatus(p.level, p.workshop),
        p.missedFights,
        p.info || ''
      ]);

      doc.autoTable({
        head: [columns],
        body: rows,
        theme: 'grid',
        styles: {
          fontSize: 8,
          textColor: '#1f1f2e',
        },
        headStyles: {
          fillColor: '#00ffc8',
          textColor: '#1f1f2e',
          fontStyle: 'bold'
        },
      });

      doc.save('Banditi_Players.pdf');
    }
  }

  // --- Guild Info ---
  function saveGuildInfo() {
    const text = document.getElementById('guildInfoText').value;
    db.collection('guildInfo').doc('main').set({ info: text })
      .then(() => alert('Guild Info ulo≈æeno'))
      .catch(err => console.error('Chyba p≈ôi ukl√°d√°n√≠ Guild Info:', err));
  }
  function loadGuildInfo() {
    db.collection('guildInfo').doc('main').get()
      .then(doc => {
        if(doc.exists) {
          document.getElementById('guildInfoText').value = doc.data().info || '';
        }
      })
      .catch(err => console.error('Chyba p≈ôi naƒç√≠t√°n√≠ Guild Info:', err));
  }

  // --- Inicializace ---
  function init() {
    loadPlayersData();
    loadGuildInfo();
  }

  window.onload = init;

</script>

</body>
</html>
